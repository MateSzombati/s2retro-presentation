<div class="controlling-container">
  <div class="title">
    <img src="assets\financeGraph.png" alt="Finance Icon">
    <h1>Controlling</h1>
  </div>

  <section class="controlling-content">
    <div class="container">
      <div class="card">
        <h2>Create Report</h2>

        <div class="report-form">

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Start Date</mat-label>
              <input matInput [matDatepicker]="startPicker" [ngModel]="startDate()" (ngModelChange)="startDate.set($event)" (dateChange)="onDateChange()">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>End Date</mat-label>
              <input matInput [matDatepicker]="endPicker" [matDatepickerFilter]="endDateFilter" [ngModel]="endDate()" (ngModelChange)="endDate.set($event)" (dateChange)="onDateChange()">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Board</mat-label>
              <mat-select [ngModel]="selectedBoard()" (ngModelChange)="selectedBoard.set($event)" (selectionChange)="onBoardSelectionChange()">
                @for (board of filteredBoards(); track board.id) {
                  <mat-option [value]="board">{{board.name}}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Instance</mat-label>
              <mat-select [ngModel]="selectedInstances()" (ngModelChange)="selectedInstances.set($event)" [disabled]="!selectedBoard()" (selectionChange)="onInstanceSelectionChange()" multiple>
                @for (instance of filteredInstances(); track instance.id) {
                  <mat-option [value]="instance">{{instance.name}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Instance Elements Table -->
          @if (selectedInstances().length > 0) {
            <div class="filter-box">
              <div class="filter-title">Instance Elements</div>
              <table>
                <thead>
                  <tr>
                    <th>Select</th>
                    <th>Name</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody>
                  @for (element of selectedInstanceElements(); track element.id) {
                    <tr>
                      <td>
                        <mat-checkbox 
                          [checked]="checkedElements().has(element.id!)" 
                          (change)="toggleElementSelection(element.id!)">
                        </mat-checkbox>
                      </td>
                      <td>{{ getElementName(element) }}</td>
                      <td>{{ getElementType(element) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Actions -->
          <div class="actions">
            <button class="btn-primary" (click)="generateReport()" [disabled]="!showPreview()">
              Generate Report
            </button>
          </div>
        </div>
      </div>
    </div>

    @if (showPreview()) {
      <div id="report-preview">
        <img src="assets/images/sidebar_logo.png" alt="Sidebar Logo" class="report-logo">
        <h2>Controlling Report</h2>

        <h3>General Information</h3>
        <p><strong>Date Range:</strong> {{ startDate()?.toLocaleDateString('de-DE') || 'N/A' }} - {{ endDate()?.toLocaleDateString('de-DE') || 'N/A' }}</p>
        <p><strong>Board:</strong> {{ selectedBoard()?.name || 'N/A' }}</p>
        <p><strong>Instance(s):</strong> 
          @for (instance of selectedInstances(); track instance.id) {
            {{ instance.name }}{{ !$last ? ', ' : '' }}
          } @empty {
            N/A
          }
        </p>
        <p><strong>Entry Phase Start:</strong> 
          @for (instance of selectedInstances(); track instance.id) {
            {{ instance.entryPhaseStart ? (instance.entryPhaseStart | date:'short':'':'de-DE') : 'N/A' }}{{ !$last ? ', ' : '' }}
          } @empty {
            N/A
          }
        </p>
        <p><strong>Entry Phase End:</strong> 
          @for (instance of selectedInstances(); track instance.id) {
            {{ instance.entryPhaseEnd ? (instance.entryPhaseEnd | date:'short':'':'de-DE') : 'N/A' }}{{ !$last ? ', ' : '' }}
          } @empty {
            N/A
          }
        </p>

        <h3>Selected Elements</h3>
        <ul>
          @for (element of getSelectedElements(); track element.id) {
            <li>{{ getElementName(element) }} ({{ getElementType(element) }})</li>
          } @empty {
            <li>No elements selected.</li>
          }
        </ul>

        @if (selectedBoard() && selectedBoard()!.instances && selectedInstances().length > 0) {
          <h3>Board Overview</h3>
          @for (instance of selectedInstances(); track instance.id) {
            <h4>Instance: {{ instance.name }}</h4>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Row Position</th>
                  @for (col of instance.columns; track col.id) {
                    <th>{{ col.name || 'N/A' }}</th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (row of instance.rows; track row.id) {
                  <tr>
                    <td>{{ row.position?.toString() || 'N/A' }}</td>
                    @for (column of instance.columns; track column.id; let colIndex = $index) {
                      <td>{{ getCellValue(row.cells?.[colIndex]) }}</td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          }
        }
      </div>
    }
  </section>
</div>